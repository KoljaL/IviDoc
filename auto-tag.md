# Generated by Copilot
# üìã Automatische Dokumenten-Verarbeitung mit LLM

Anleitung zur automatischen Extraktion von Korrespondent, Dateinamen und Tags aus Dokumenten in Paperless-NGX mit LeoLM 13B.

---

## üéØ √úbersicht

Beim Einlesen von Dokumenten werden automatisch extrahiert:
- **Korrespondent** (Absender/Firma)
- **Dokumenttyp** (Rechnung, Vertrag, etc.)
- **Tags** (Kategorien)
- **Datum**
- **Intelligenter Dateiname**

---

## 1Ô∏è‚É£ Basis-Konfiguration in Paperless-NGX

### Automatische Dateinamen

Bereits in [`docker-compose.yml`](docker-compose.yml) konfiguriert:

```yaml
PAPERLESS_FILENAME_FORMAT: '{created_year}/{correspondent}/{title}'
PAPERLESS_FILENAME_FORMAT_REMOVE_NONE: true
```

**Ergebnis:** `2026/Deutsche-Telekom/Rechnung-Januar.pdf`

**Alternative Formate:**
```yaml
# Mit Datum
PAPERLESS_FILENAME_FORMAT: '{created_year}-{created_month}-{created_day}_{correspondent}_{title}'

# Mit Dokumenttyp
PAPERLESS_FILENAME_FORMAT: '{document_type}/{created_year}/{correspondent}_{title}'

# Mit Tags
PAPERLESS_FILENAME_FORMAT: '{created_year}/{correspondent}/{tags[0]}_{title}'
```

---

## 2Ô∏è‚É£ Korrespondenten automatisch erkennen

### Web-UI Konfiguration

1. **Paperless √∂ffnen:** http://localhost:8000
2. **Settings ‚Üí Correspondents ‚Üí Add Correspondent**
3. **Beispiel konfigurieren:**

| Feld                   | Wert                                              |
| ---------------------- | ------------------------------------------------- |
| **Name**               | Deutsche Telekom                                  |
| **Matching algorithm** | Auto                                              |
| **Match**              | `Deutsche Telekom\|Telekom Deutschland\|T-Mobile` |
| **Auto-assign**        | ‚úÖ Aktiviert                                       |

4. **Weitere Korrespondenten hinzuf√ºgen:**
   - Stadtwerke
   - Versicherung
   - Vermieter
   - usw.

### Machine Learning Training

Nach ~50 manuell zugewiesenen Dokumenten:

```bash
cd /Users/lasarkolja/Code/IviDoc

# Training starten
docker compose exec paperless document_retagger \
  --correspondent-algorithm auto \
  --overwrite
```

**Paperless lernt dann automatisch aus Ihren Zuordnungen!**

---

## 3Ô∏è‚É£ Tags automatisch zuweisen

### Regel-basierte Tags

1. **Settings ‚Üí Tags ‚Üí Add Tag**
2. **Beispiele:**

#### Tag: Rechnung
| Feld                | Wert                                                       |
| ------------------- | ---------------------------------------------------------- |
| **Name**            | Rechnung                                                   |
| **Color**           | Rot                                                        |
| **Match**           | `Rechnung\|Invoice\|Betrag\|Rechnungsnummer\|EUR\|Zahlbar` |
| **Match algorithm** | Any                                                        |
| **Auto-assign**     | ‚úÖ                                                          |

#### Tag: Vertrag
| Feld            | Wert                                                            |
| --------------- | --------------------------------------------------------------- |
| **Name**        | Vertrag                                                         |
| **Match**       | `Vertrag\|Contract\|Laufzeit\|K√ºndigungsfrist\|Vertragspartner` |
| **Auto-assign** | ‚úÖ                                                               |

#### Tag: Mahnung
| Feld            | Wert                                              |
| --------------- | ------------------------------------------------- |
| **Name**        | Mahnung                                           |
| **Color**       | Orange                                            |
| **Match**       | `Mahnung\|Zahlungserinnerung\|√ºberf√§llig\|Verzug` |
| **Auto-assign** | ‚úÖ                                                 |

#### Tag: Steuer
| Feld            | Wert                                            |
| --------------- | ----------------------------------------------- |
| **Name**        | Steuer                                          |
| **Match**       | `Steuer\|Finanzamt\|Steuernummer\|Umsatzsteuer` |
| **Auto-assign** | ‚úÖ                                               |

---

## 4Ô∏è‚É£ LLM-basierte intelligente Extraktion

### Voraussetzungen

- ‚úÖ LeoLM 13B installiert (via `install-leolm.sh`)
- ‚úÖ AI-Profil aktiv (`docker compose --profile ai up -d`)
- ‚úÖ Paperless API Token erstellt

### API Token erstellen

1. **Web-UI:** Settings ‚Üí API Tokens
2. **Create Token** ‚Üí Token kopieren
3. In [`llm-tagger.py`](llm-tagger.py) einf√ºgen

### Dateien erstellen

#### llm-tagger.py

```python
# Generated by Copilot
#!/usr/bin/env python3
"""
LLM-basierte automatische Tag/Korrespondent-Extraktion f√ºr Paperless-NGX
Nutzt LeoLM 13B via Ollama
"""

import requests
import json
import sys

PAPERLESS_URL = "http://localhost:8000"
PAPERLESS_TOKEN = "YOUR_API_TOKEN"  # Settings ‚Üí API Tokens
OLLAMA_URL = "http://localhost:11434"

def analyze_document(text):
    """Analysiere Text mit LeoLM"""
    prompt = f"""Analysiere dieses deutsche Dokument und extrahiere:
- Korrespondent (Absender/Firma)
- Dokumenttyp (z.B. Rechnung, Vertrag, Brief)
- Wichtige Tags (max 5)
- Datum (falls erkennbar)

Dokument:
{text[:2000]}

Antworte nur im JSON-Format:
{{"korrespondent": "...", "typ": "...", "tags": ["...", "..."], "datum": "YYYY-MM-DD"}}
"""
    
    response = requests.post(
        f"{OLLAMA_URL}/api/generate",
        json={
            "model": "leolm-german:13b",
            "prompt": prompt,
            "stream": False
        }
    )
    
    result = response.json()['response']
    return json.loads(result)

def update_paperless_document(doc_id, data):
    """Update Paperless-Dokument"""
    headers = {"Authorization": f"Token {PAPERLESS_TOKEN}"}
    
    # Korrespondent erstellen/finden
    if data.get('korrespondent'):
        corr_resp = requests.post(
            f"{PAPERLESS_URL}/api/correspondents/",
            headers=headers,
            json={"name": data['korrespondent']}
        )
        corr_id = corr_resp.json().get('id')
    
    # Tags erstellen/finden
    tag_ids = []
    for tag_name in data.get('tags', []):
        tag_resp = requests.post(
            f"{PAPERLESS_URL}/api/tags/",
            headers=headers,
            json={"name": tag_name}
        )
        tag_ids.append(tag_resp.json().get('id'))
    
    # Dokument updaten
    requests.patch(
        f"{PAPERLESS_URL}/api/documents/{doc_id}/",
        headers=headers,
        json={
            "correspondent": corr_id,
            "tags": tag_ids,
            "created": data.get('datum')
        }
    )

if __name__ == "__main__":
    doc_id = sys.argv[1]
    
    # Dokument-Text von Paperless holen
    headers = {"Authorization": f"Token {PAPERLESS_TOKEN}"}
    doc = requests.get(
        f"{PAPERLESS_URL}/api/documents/{doc_id}/",
        headers=headers
    ).json()
    
    # Mit LLM analysieren
    analysis = analyze_document(doc['content'])
    
    # Paperless updaten
    update_paperless_document(doc_id, analysis)
    
    print(f"‚úÖ Dokument {doc_id} analysiert: {analysis}")
```

#### auto-process.sh

```bash
# Generated by Copilot
#!/bin/bash
# Automatische LLM-basierte Verarbeitung neuer Dokumente

while true; do
    # Alle unverarbeiteten Dokumente
    DOCS=$(docker compose exec -T paperless python manage.py shell -c "
from documents.models import Document
import json
docs = Document.objects.filter(correspondent__isnull=True)[:10]
print(json.dumps([d.id for d in docs]))
    ")
    
    # Jeden Dokument mit LLM verarbeiten
    for DOC_ID in $(echo $DOCS | jq -r '.[]'); do
        echo "üîç Verarbeite Dokument $DOC_ID..."
        python3 llm-tagger.py $DOC_ID
        sleep 5
    done
    
    # Alle 5 Minuten pr√ºfen
    sleep 300
done
```

### Manuell testen

```bash
cd /Users/lasarkolja/Code/IviDoc

# Scripts ausf√ºhrbar machen
chmod +x llm-tagger.py auto-process.sh

# Einzelnes Dokument analysieren (ID aus Web-UI)
python3 llm-tagger.py 123

# Ergebnis:
# ‚úÖ Dokument 123 analysiert: {
#   "korrespondent": "Deutsche Telekom",
#   "typ": "Rechnung",
#   "tags": ["Rechnung", "Telekommunikation", "Mobil"],
#   "datum": "2026-01-15"
# }
```

### Automatisches Processing aktivieren

Erg√§nze in [`docker-compose.yml`](docker-compose.yml):

```yaml
  # Auto-Tagger Service
  auto-tagger:
    image: python:3.11-slim
    restart: unless-stopped
    depends_on:
      - paperless
      - ollama
    volumes:
      - ./llm-tagger.py:/app/llm-tagger.py
      - ./auto-process.sh:/app/auto-process.sh
    working_dir: /app
    command: >
      bash -c "pip install requests &&
               chmod +x auto-process.sh llm-tagger.py &&
               ./auto-process.sh"
    networks:
      - paperless
    profiles:
      - ai
```

Dann starten:

```bash
# Auto-Tagger starten
docker compose --profile ai up -d auto-tagger

# Status pr√ºfen
docker compose logs -f auto-tagger
```

---

## 5Ô∏è‚É£ Workflow-Beispiel

### Szenario: Telekom-Rechnung scannen

1. **PDF erstellen** mit Smartphone
2. **In `consume/` kopieren:**
   ```bash
   cp ~/Downloads/rechnung.pdf /Users/lasarkolja/Code/IviDoc/consume/
   ```

3. **Paperless verarbeitet automatisch** (~30 Sek):
   - ‚úÖ OCR-Erkennung
   - ‚úÖ Text extrahiert
   - ‚úÖ Gespeichert in Datenbank

4. **Auto-Tagger analysiert** (~20 Sek):
   - ü§ñ LeoLM liest Dokument
   - ‚úÖ Erkennt: "Deutsche Telekom"
   - ‚úÖ Erstellt Korrespondent (falls neu)
   - ‚úÖ Tags: `Rechnung`, `Telekommunikation`
   - ‚úÖ Datum: `2026-01-15`

5. **Ergebnis in Paperless:**
   - **Korrespondent:** Deutsche Telekom
   - **Tags:** Rechnung, Telekommunikation
   - **Datum:** 15.01.2026
   - **Dateiname:** `2026/Deutsche-Telekom/Rechnung-Januar-2026.pdf`
   - **Volltext durchsuchbar**

---

## 6Ô∏è‚É£ Machine Learning optimieren

### Training mit Korrekturen

Nach jedem **manuell korrigierten** Dokument:

```bash
# Alle 100 Dokumente neu trainieren
docker compose exec paperless document_retagger \
  --tags-algorithm auto \
  --correspondent-algorithm auto \
  --document-type-algorithm auto \
  --overwrite
```

**Je mehr Dokumente Sie korrigieren, desto besser wird das System!**

### Statistiken ansehen

```bash
# Wie viele Dokumente haben welchen Korrespondenten?
docker compose exec paperless python manage.py shell -c "
from documents.models import Correspondent, Document
for corr in Correspondent.objects.all():
    count = Document.objects.filter(correspondent=corr).count()
    print(f'{corr.name}: {count} Dokumente')
"
```

---

## 7Ô∏è‚É£ Troubleshooting

### LLM antwortet nicht

```bash
# Ollama-Status pr√ºfen
docker compose exec ollama ollama list

# LeoLM testen
docker compose exec ollama ollama run leolm-german:13b "Hallo"

# Neu starten
docker compose restart ollama
```

### Auto-Tagger l√§uft nicht

```bash
# Logs ansehen
docker compose logs auto-tagger

# Manuell starten
docker compose --profile ai up -d auto-tagger

# Python-Abh√§ngigkeiten pr√ºfen
docker compose exec auto-tagger pip list
```

### API Token funktioniert nicht

```bash
# In Paperless Web-UI neuen Token erstellen
# Settings ‚Üí API Tokens ‚Üí Create ‚Üí Kopieren

# In llm-tagger.py ersetzen:
# PAPERLESS_TOKEN = "dein_neuer_token_hier"
```

### Dokument wird nicht erkannt

```bash
# OCR-Qualit√§t pr√ºfen
docker compose exec paperless python manage.py shell -c "
from documents.models import Document
doc = Document.objects.get(id=123)
print(doc.content[:1000])  # Erste 1000 Zeichen
"

# Falls Text leer/schlecht:
# ‚Üí OCR-Einstellungen in docker-compose.yml anpassen
# ‚Üí H√∂here DPI: PAPERLESS_OCR_IMAGE_DPI: 400
```

---

## 8Ô∏è‚É£ Erweiterte Funktionen

### Barcode-Unterst√ºtzung

Bereits in [`docker-compose.yml`](docker-compose.yml) aktiviert:

```yaml
PAPERLESS_CONSUMER_ENABLE_BARCODES: true
PAPERLESS_CONSUMER_ENABLE_ASN_BARCODE: true
PAPERLESS_CONSUMER_BARCODE_SCANNER: PYZBAR
```

**Nutzen Sie Barcode-Labels auf Dokumenten f√ºr automatische Zuordnung!**

### Email-Import

In [`docker-compose.yml`](docker-compose.yml) erg√§nzen:

```yaml
PAPERLESS_CONSUMER_IMAP_SERVER: imap.gmail.com
PAPERLESS_CONSUMER_IMAP_PORT: 993
PAPERLESS_CONSUMER_IMAP_SECURITY: SSL
PAPERLESS_CONSUMER_IMAP_USER: ihre-email@gmail.com
PAPERLESS_CONSUMER_IMAP_PASSWORD: ihr-app-passwort
```

### Webhook-Benachrichtigungen

```yaml
# Bei jedem neuen Dokument Webhook aufrufen
PAPERLESS_POST_CONSUME_SCRIPT: /usr/src/paperless/scripts/notify.sh
```

---

## 9Ô∏è‚É£ Best Practices

### Ordnerstruktur im Smartphone

Scannen Sie direkt in Kategorien:

```
Cloud-Sync/IviDoc/
‚îú‚îÄ‚îÄ Rechnungen/
‚îú‚îÄ‚îÄ Vertr√§ge/
‚îú‚îÄ‚îÄ Medizin/
‚îú‚îÄ‚îÄ Versicherung/
‚îî‚îÄ‚îÄ Sonstiges/
```

**Paperless liest Unterordner automatisch** (`PAPERLESS_CONSUMER_RECURSIVE: true`)

### Tag-Hierarchie

Nutzen Sie Haupt- und Unter-Tags:

- `Rechnung` ‚Üí `Rechnung:Strom`, `Rechnung:Internet`
- `Vertrag` ‚Üí `Vertrag:Miete`, `Vertrag:Handy`
- `Medizin` ‚Üí `Medizin:Arzt`, `Medizin:Rezept`

### Regelm√§√üige Backups

```bash
# T√§glich ausf√ºhren
./backup.sh

# Oder Cron-Job einrichten:
# crontab -e
# 0 2 * * * cd /Users/lasarkolja/Code/IviDoc && ./backup.sh
```

---

## üéØ Zusammenfassung

Nach dieser Einrichtung:

1. **PDF in `consume/` kopieren**
2. **System arbeitet automatisch:**
   - ‚úÖ OCR
   - ‚úÖ Korrespondent erkennen
   - ‚úÖ Tags zuweisen
   - ‚úÖ Datum extrahieren
   - ‚úÖ Intelligenter Dateiname
   - ‚úÖ Archivierung

3. **Sie nur noch:**
   - Gelegentlich Korrekturen machen
   - System lernt daraus
   - Wird immer besser!

**Nach ~100 Dokumenten arbeitet das System zu ~80-90% automatisch!** üöÄ

---

## üìö Links

- [Paperless-NGX Dokumentation](https://docs.paperless-ngx.com/)
- [Ollama Modelle](https://ollama.ai/library)
- [LeoLM GitHub](https://github.com/bjoernpl/LeoLM)
- [IviDoc Repository](https://github.com/KoljaL/IviDoc)

---

**Erstellt:** 10.02.2026  
**F√ºr:** IviDoc - Intelligentes Dokumenten-Management-System