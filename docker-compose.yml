# Generated by Copilot
# Paperless-NGX Setup für M4 MacBook Air
# Optimiert für ARM64 Architektur mit Tika, Gotenberg & optionalem AI-Profil
#
# Standard-Start (ohne AI): docker compose up -d
# Mit AI-Features:          docker compose --profile ai up -d

version: '3.9'

services:
  # --------------------
  # Redis (Task Broker)
  # --------------------
  broker:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redisdata:/data
    networks:
      - paperless

  # --------------------
  # PostgreSQL (Database)
  # --------------------
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: paperless
      POSTGRES_USER: paperless
      POSTGRES_PASSWORD: paperless
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - paperless

  # --------------------
  # Gotenberg (PDF Engine)
  # --------------------
  gotenberg:
    image: gotenberg/gotenberg:8
    restart: unless-stopped
    networks:
      - paperless

  # --------------------
  # Apache Tika (Text Extraction)
  # --------------------
  tika:
    image: apache/tika:latest
    restart: unless-stopped
    networks:
      - paperless

  # --------------------
  # Paperless-NGX
  # --------------------
  paperless:
    image: ghcr.io/paperless-ngx/paperless-ngx:latest
    restart: unless-stopped
    depends_on:
      - db
      - broker
      - gotenberg
      - tika
    ports:
      - '8000:8000'

    volumes:
      - ./data:/usr/src/paperless/data
      - ./media:/usr/src/paperless/media
      - ./export:/usr/src/paperless/export
      - ./consume:/usr/src/paperless/consume

    environment:
      # --- Infrastruktur ---
      PAPERLESS_REDIS: redis://broker:6379
      PAPERLESS_DBHOST: db
      PAPERLESS_DBNAME: paperless
      PAPERLESS_DBUSER: paperless
      PAPERLESS_DBPASS: paperless

      # --- Lokalisierung ---
      PAPERLESS_TIME_ZONE: Europe/Berlin
      PAPERLESS_OCR_LANGUAGE: deu
      PAPERLESS_OCR_LANGUAGES: deu+eng+deu_frak

      # --- Admin (nur beim ersten Start relevant) ---
      PAPERLESS_ADMIN_USER: admin
      PAPERLESS_ADMIN_PASSWORD: admin
      PAPERLESS_ADMIN_MAIL: admin@localhost

      # --- Performance (optimiert für M4 Air) ---
      PAPERLESS_TASK_WORKERS: 3
      PAPERLESS_THREADS_PER_WORKER: 3

      # --- OCR-Qualität (Handy-Scans) ---
      PAPERLESS_OCR_MODE: redo
      PAPERLESS_OCR_CLEAN: clean
      PAPERLESS_OCR_DESKEW: true
      PAPERLESS_OCR_ROTATE_PAGES: true
      PAPERLESS_OCR_OUTPUT_TYPE: pdfa
      PAPERLESS_OCR_PAGES: 0
      PAPERLESS_OCR_IMAGE_DPI: 300
      PAPERLESS_OCR_MAX_IMAGE_PIXELS: 128000000
      PAPERLESS_OCR_COLOR_CONVERSION_STRATEGY: RGB
      PAPERLESS_OCR_USER_ARGS: '{"continue_on_soft_render_error": true, "invalidate_digital_signatures": true}'
      PAPERLESS_OCR_ROTATE_PAGES_THRESHOLD: 12

      # --- Dokument-Import ---
      PAPERLESS_CONSUMER_POLLING: 10
      PAPERLESS_CONSUMER_RECURSIVE: true
      PAPERLESS_CONSUMER_DELETE_DUPLICATES: true

      # --- Barcode-Erkennung (optional, aber nützlich) ---
      PAPERLESS_CONSUMER_ENABLE_BARCODES: true
      PAPERLESS_CONSUMER_ENABLE_ASN_BARCODE: true
      PAPERLESS_CONSUMER_BARCODE_SCANNER: PYZBAR

      # --- PDF/Text-Analyse ---
      PAPERLESS_TIKA_ENABLED: true
      PAPERLESS_TIKA_ENDPOINT: http://tika:9998
      PAPERLESS_TIKA_GOTENBERG_ENDPOINT: http://gotenberg:3000

      # --- URL ---
      PAPERLESS_URL: http://localhost:8000

    networks:
      - paperless

  # ==================================================
  # OPTIONAL: Lokales LLM (AI-Profil)
  # ==================================================
  ollama:
    image: ollama/ollama
    restart: unless-stopped
    volumes:
      - ollama:/root/.ollama
    ports:
      - '11434:11434'
    networks:
      - paperless
    profiles:
      - ai

  # ==================================================
  # OPTIONAL: Paperless-AI (AI-Profil)
  # ==================================================
  paperless-ai:
    image: clusterzx/paperless-ai:latest
    restart: unless-stopped
    depends_on:
      - paperless
      - ollama
    environment:
      PAPERLESS_URL: http://paperless:8000
      OLLAMA_URL: http://ollama:11434
    networks:
      - paperless
    profiles:
      - ai

# --------------------
# Volumes
# --------------------
volumes:
  pgdata:
  redisdata:
  ollama:

# --------------------
# Network
# --------------------
networks:
  paperless:
